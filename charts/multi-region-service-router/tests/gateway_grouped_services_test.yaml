suite: gateway grouped services test
templates:
  - dnsendpoint.yaml
  - istio-gateway.yaml
release:
  name: test-release
  namespace: default
tests:
  - it: should support gateway-grouped service format
    values:
      - ./values/gateway-grouped-services-values.yaml
    asserts:
      # Check Gateway resources
      - isKind:
          of: Gateway
        documentIndex: 0
        template: istio-gateway.yaml
      - equal:
          path: metadata.name
          value: default-gateway-ingress
        documentIndex: 0
        template: istio-gateway.yaml
      - isKind:
          of: Gateway
        documentIndex: 1
        template: istio-gateway.yaml
      - equal:
          path: metadata.name
          value: internal-gateway-ingress
        documentIndex: 1
        template: istio-gateway.yaml
        
      # Verify default gateway has the right services
      - contains:
          path: spec.servers[0].hosts
          content: service-02-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
        template: istio-gateway.yaml
      - contains:
          path: spec.servers[0].hosts
          content: service-03-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
        template: istio-gateway.yaml
      - contains:
          path: spec.servers[0].hosts
          content: service-05-ns-d-dev-app-02.aks.example.com
        documentIndex: 0
        template: istio-gateway.yaml
        
      # Verify internal gateway has the right services
      - contains:
          path: spec.servers[0].hosts
          content: service-01-ns-d-dev-app-01.aks.example.com
        documentIndex: 1
        template: istio-gateway.yaml
      - contains:
          path: spec.servers[0].hosts
          content: service-04-ns-d-dev-app-02.aks.example.com
        documentIndex: 1
        template: istio-gateway.yaml
      
      # Check DNS Endpoint resources
      - isKind:
          of: DNSEndpoint
        documentIndex: 0
        template: dnsendpoint.yaml
      - equal:
          path: metadata.name
          value: external-dns-neu
        documentIndex: 0
        template: dnsendpoint.yaml
      
      # Verify that the correct endpoints are created in the DNS Endpoint resource
      - lengthEqual:
          path: spec.endpoints
          count: 5
        documentIndex: 0
        template: dnsendpoint.yaml
      
      # Verify specific endpoints by hostname
      - matchRegex:
          path: spec.endpoints[0].dnsName
          pattern: service-02-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
        template: dnsendpoint.yaml
      - matchRegex:
          path: spec.endpoints[1].dnsName
          pattern: service-03-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
        template: dnsendpoint.yaml
      - matchRegex:
          path: spec.endpoints[2].dnsName
          pattern: service-01-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
        template: dnsendpoint.yaml
