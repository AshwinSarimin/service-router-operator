suite: istio-gateway template tests
templates:
  - istio-gateway.yaml
release:
  name: test-release
  namespace: default
tests:
  - it: should create Gateway resources for each gateway configuration
    values:
      - ./values/istio-gateway-basic-values.yaml
    asserts:
      - isKind:
          of: Gateway
        documentIndex: 0
      - equal:
          path: metadata.name
          value: default-gateway-ingress
        documentIndex: 0
      - equal:
          path: spec.selector.istio
          value: istio-ingressgateway
        documentIndex: 0
      - equal:
          path: spec.servers[0].tls.credentialName
          value: example-cert
        documentIndex: 0
      - contains:
          path: spec.servers[0].hosts
          content: service-01-ns-d-dev-app-01.aks.example.com
        documentIndex: 0

  - it: should create multiple Gateway resources with correct services assigned
    set:
      cluster: aks01
      region: neu
      environmentLetter: d
      domain: aks.example.com
      defaultGateway: default-gateway-ingress
      apps:
        - name: app-01
          services:
            internal-gateway-ingress:
              - service-01
            default-gateway-ingress:
              - service-02
          environment: dev
      gateways:
        - name: default-gateway-ingress
          controller: istio-ingressgateway
          credentialName: example-cert
          targetPostfix: external
        - name: internal-gateway-ingress
          controller: istio-ingressgateway-internal
          credentialName: internal-cert
          targetPostfix: internal
    asserts:
      - isKind:
          of: Gateway
        documentIndex: 0
      - equal:
          path: metadata.name
          value: default-gateway-ingress
        documentIndex: 0
      - isKind:
          of: Gateway
        documentIndex: 1
      - equal:
          path: metadata.name
          value: internal-gateway-ingress
        documentIndex: 1
      - contains:
          path: spec.servers[0].hosts
          content: service-02-ns-d-dev-app-01.aks.example.com
        documentIndex: 0
      - contains:
          path: spec.servers[0].hosts
          content: service-01-ns-d-dev-app-01.aks.example.com
        documentIndex: 1

  - it: should render the correct httpsPortNumber when set
    set:
      cluster: aks01
      region: neu
      environmentLetter: d
      domain: aks.example.com
      defaultGateway: default-gateway-ingress
      apps:
        - name: app-01
          services:
            default-gateway-ingress:
              - service-02
          environment: dev
      gateways:
        - name: default-gateway-ingress
          controller: istio-ingressgateway
          credentialName: example-cert
          targetPostfix: external
          httpsPortNumber: 8443
    asserts:
      - isKind:
          of: Gateway
        documentIndex: 0
      - equal:
          path: spec.servers[0].port.number
          value: 8443
        documentIndex: 0

  - it: should render the default httpsPortNumber as 443 when not set
    set:
      cluster: aks01
      region: neu
      environmentLetter: d
      domain: aks.example.com
      defaultGateway: default-gateway-ingress
      apps:
        - name: app-01
          services:
            default-gateway-ingress:
              - service-02
          environment: dev
      gateways:
        - name: default-gateway-ingress
          controller: istio-ingressgateway
          credentialName: example-cert
          targetPostfix: external
    asserts:
      - isKind:
          of: Gateway
        documentIndex: 0
      - equal:
          path: spec.servers[0].port.number
          value: 443
        documentIndex: 0
