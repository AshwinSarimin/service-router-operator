%%{init: {'theme':'base', 'themeVariables': {'primaryTextColor':'#000000', 'primaryColor':'#e3f2fd', 'primaryBorderColor':'#1565c0', 'lineColor':'#333333', 'secondaryColor':'#fff3e0', 'tertiaryColor':'#e8f5e9', 'noteTextColor':'#000000', 'noteBkgColor':'#fff9c4', 'noteBorderColor':'#f57f17'}}}%%
%% Service Router Operator - CRD Relationships and Ownership
%% Shows how CRDs relate to each other and who owns them

graph TB
    %% Ownership Legend
    subgraph legend["ğŸ‘¥ Ownership Legend"]
        platform["ğŸ”§ Platform Team<br/>(Cluster Admin)"]
        app["ğŸ‘¨â€ğŸ’» Application Team<br/>(Namespace Admin)"]
        operator["âš™ï¸ Operator<br/>(Generated)"]
        external["ğŸ”Œ External System<br/>(ExternalDNS)"]
    end

    %% Cluster-Scoped Resources
    subgraph clusterScope["ğŸŒ Cluster-Scoped Resources (Platform Team)"]
        clusterIdentity["ClusterIdentity<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ”§ Platform Owned<br/>ğŸ“ Cluster Scoped<br/>ğŸ”’ Singleton<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Defines:<br/>â€¢ Region<br/>â€¢ Cluster ID<br/>â€¢ Domain<br/>â€¢ Environment<br/>â€¢ Adopted Regions"]

        dnsConfiguration["DNSConfiguration<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ”§ Platform Owned<br/>ğŸ“ Cluster Scoped<br/>ğŸ”’ Singleton<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Defines:<br/>â€¢ All ExternalDNS controllers<br/>â€¢ Controller-to-region mapping"]
    end

    %% Namespace-Scoped Resources
    subgraph namespaceScope["ğŸ“¦ Namespace-Scoped Resources"]
        gateway["Gateway<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ”§ Platform Owned<br/>ğŸ“ Namespace Scoped<br/>ğŸ” Reusable<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Defines:<br/>â€¢ Istio Gateway selector<br/>â€¢ TLS certificate<br/>â€¢ Target postfix"]

        dnsPolicy["DNSPolicy<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ‘¨â€ğŸ’» Application Owned<br/>ğŸ“ Namespace Scoped<br/>ğŸ” One per namespace<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Defines:<br/>â€¢ Mode (Active/RegionBound)<br/>â€¢ Source region/cluster<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Status:<br/>â€¢ activeControllers (computed)"]

        serviceRoute["ServiceRoute<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ‘¨â€ğŸ’» Application Owned<br/>ğŸ“ Namespace Scoped<br/>ğŸ” Multiple per namespace<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Defines:<br/>â€¢ Service name<br/>â€¢ Gateway reference<br/>â€¢ Environment label<br/>â€¢ Application label<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Status:<br/>â€¢ DNS records created<br/>â€¢ Reconciliation state"]
    end

    %% Generated Istio Resources
    subgraph istioResources["ğŸŒŠ Generated Istio Resources"]
        istioGateway["Istio Gateway<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âš™ï¸ Operator Generated<br/>ğŸ“ Namespace Scoped<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Contains:<br/>â€¢ Host wildcard (*.domain)<br/>â€¢ TLS configuration<br/>â€¢ Gateway selector<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Owner: Gateway CRD"]
    end

    %% Generated DNS Resources
    subgraph dnsResources["ğŸ”Œ Generated DNS Resources"]
        dnsEndpoint["DNSEndpoint CRDs<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âš™ï¸ Operator Generated<br/>ğŸ“ Namespace Scoped<br/>ğŸ” One per controller<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Contains:<br/>â€¢ DNS hostname<br/>â€¢ Target hostname<br/>â€¢ Controller annotation<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Owner: ServiceRoute CRD"]

        azureDNS["Azure Private DNS<br/>â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ”Œ ExternalDNS Managed<br/>â˜ï¸ Cloud Resource<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Contains:<br/>â€¢ A records<br/>â€¢ TTL<br/>â€¢ Target IP resolution"]
    end

    %% Relationships - Reading
    clusterIdentity -.->|"Read by"| gateway
    clusterIdentity -.->|"Read by"| dnsPolicy
    clusterIdentity -.->|"Read by"| serviceRoute
    dnsConfiguration -.->|"Read by"| dnsPolicy
    gateway -.->|"Read by"| serviceRoute
    dnsPolicy -.->|"Read by"| serviceRoute

    %% Relationships - Generation
    gateway -->|"Generates<br/>(ownerRef)"| istioGateway
    serviceRoute -->|"Generates<br/>(ownerRef)"| dnsEndpoint
    dnsEndpoint -->|"Watched by<br/>ExternalDNS"| azureDNS

    %% Cross-references
    serviceRoute -.->|"References<br/>(spec.gatewayName)"| gateway

    %% Cardinality Notes
    subgraph cardinality["ğŸ“Š Cardinality Rules"]
        c1["1ï¸âƒ£ ClusterIdentity per cluster"]
        c2["1ï¸âƒ£ DNSConfiguration per cluster"]
        c3["Nï¸âƒ£ Gateways (typically in istio-system)"]
        c4["1ï¸âƒ£ DNSPolicy per namespace"]
        c5["Nï¸âƒ£ ServiceRoutes per namespace"]
        c6["Nï¸âƒ£ DNSEndpoints per ServiceRoute<br/>(one per active controller)"]
    end

    %% Reconciliation Flow
    subgraph reconciliation["ğŸ”„ Reconciliation Order"]
        r1["1ï¸âƒ£ ClusterIdentity reconciled<br/>â†’ Cached"]
        r2["2ï¸âƒ£ DNSConfiguration reconciled<br/>â†’ Cached"]
        r3["3ï¸âƒ£ Gateway reconciled<br/>â†’ Creates Istio Gateway"]
        r4["4ï¸âƒ£ DNSPolicy reconciled<br/>â†’ Computes activeControllers"]
        r5["5ï¸âƒ£ ServiceRoute reconciled<br/>â†’ Creates DNSEndpoints"]

        r1 --> r2 --> r3 --> r4 --> r5
    end

    %% Deletion Cascade
    subgraph deletion["ğŸ—‘ï¸ Deletion Cascade (ownerReferences)"]
        d1["Delete Gateway<br/>â†’ Istio Gateway deleted"]
        d2["Delete ServiceRoute<br/>â†’ DNSEndpoints deleted"]
        d3["Delete DNSEndpoint<br/>â†’ DNS records removed<br/>(by ExternalDNS)"]

        d1 --> d2 --> d3
    end

    %% Styling
    classDef platformOwned fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    classDef appOwned fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef generated fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef external fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef info fill:#fff9c4,stroke:#f57f17,stroke-width:1px

    class clusterIdentity,dnsConfiguration,gateway platformOwned
    class dnsPolicy,serviceRoute appOwned
    class istioGateway,dnsEndpoint generated
    class azureDNS external
    class c1,c2,c3,c4,c5,c6,r1,r2,r3,r4,r5,d1,d2,d3,platform,app,operator,external info
