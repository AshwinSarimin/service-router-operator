%%{init: {'theme':'base', 'themeVariables': {'primaryTextColor':'#000000', 'primaryColor':'#e3f2fd', 'primaryBorderColor':'#1565c0', 'lineColor':'#333333', 'secondaryColor':'#fff3e0', 'tertiaryColor':'#e8f5e9', 'noteTextColor':'#000000', 'noteBkgColor':'#fff9c4', 'noteBorderColor':'#f57f17'}}}%%
%% Service Router Operator - DNS Routing Modes
%% Shows the difference between Active mode and RegionBound mode

graph TB
    subgraph scenario["ğŸ“‹ Scenario: 3 Regions, WEU Cluster Active"]
        note["ClusterIdentity: region=weu, cluster=aks01<br/>DNSConfiguration: external-dns-weu, external-dns-neu, external-dns-frc"]
    end

    %% Active Mode
    subgraph activeMode["ğŸŸ¢ Active Mode (Regional Isolation)"]
        direction TB
        activeDNSPolicy["DNSPolicy<br/>â”€â”€â”€â”€â”€â”€â”€<br/>mode: Active<br/>sourceRegion: weu"]

        activeLogic["Logic:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Current region: weu<br/>Filter controllers where<br/>region == weu"]

        activeControllers["status.activeControllers:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ… external-dns-weu"]

        activeDNSPolicy --> activeLogic
        activeLogic --> activeControllers

        subgraph activeDNS["DNS Records Created"]
            activeWEU["West Europe DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
        end

        activeControllers --> activeWEU

        subgraph activeResult["Result"]
            activeTraffic["âœ… WEU clients â†’ WEU cluster<br/>âŒ NEU clients â†’ no DNS record<br/>âŒ FRC clients â†’ no DNS record"]
        end

        activeDNS --> activeResult
    end

    %% RegionBound Mode
    subgraph regionBoundMode["ğŸ”µ RegionBound Mode (Cross-Region Consolidation)"]
        direction TB
        rbDNSPolicy["DNSPolicy<br/>â”€â”€â”€â”€â”€â”€â”€<br/>mode: RegionBound<br/>sourceRegion: weu<br/>sourceCluster: aks01"]

        rbLogic["Logic:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Include ALL controllers"]

        rbControllers["status.activeControllers:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ… external-dns-weu<br/>âœ… external-dns-neu<br/>âœ… external-dns-frc"]

        rbDNSPolicy --> rbLogic
        rbLogic --> rbControllers

        subgraph rbDNS["DNS Records Created"]
            rbWEU["West Europe DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
            rbNEU["North Europe DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
            rbFRC["France Central DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
        end

        rbControllers --> rbWEU
        rbControllers --> rbNEU
        rbControllers --> rbFRC

        subgraph rbResult["Result"]
            rbTraffic["âœ… WEU clients â†’ WEU cluster<br/>âœ… NEU clients â†’ WEU cluster<br/>âœ… FRC clients â†’ WEU cluster<br/>(Cross-region traffic)"]
        end

        rbDNS --> rbResult
    end

    %% Migration Scenario
    subgraph migrationMode["ğŸ”„ Migration Scenario: Orphan Region Adoption"]
        direction TB
        migrationCI["ClusterIdentity<br/>â”€â”€â”€â”€â”€â”€â”€<br/>region: weu<br/>cluster: aks01<br/>adoptsRegions: [frc]"]

        migrationDNSPolicy["DNSPolicy<br/>â”€â”€â”€â”€â”€â”€â”€<br/>mode: Active<br/>sourceRegion: weu"]

        migrationLogic["Logic:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Current region: weu<br/>Adopted regions: [frc]<br/>Include controllers where<br/>region IN [weu, frc]"]

        migrationControllers["status.activeControllers:<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ… external-dns-weu<br/>âœ… external-dns-frc"]

        migrationCI --> migrationLogic
        migrationDNSPolicy --> migrationLogic
        migrationLogic --> migrationControllers

        subgraph migrationDNS["DNS Records Created"]
            migWEU["West Europe DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
            migFRC["France Central DNS Zone<br/>â”€â”€â”€â”€â”€â”€â”€<br/>myapp.example.com<br/>â†’ aks01-weu-internal"]
        end

        migrationControllers --> migWEU
        migrationControllers --> migFRC

        subgraph migrationResult["Result"]
            migTraffic["âœ… WEU clients â†’ WEU cluster<br/>âŒ NEU clients â†’ no DNS record<br/>âœ… FRC clients â†’ WEU cluster<br/>(FRC region adopted by WEU)"]
        end

        migrationDNS --> migrationResult
    end

    %% Use Case Descriptions
    subgraph useCases["ğŸ’¡ When to Use Each Mode"]
        direction TB
        activeUC["Active Mode<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Regional isolation required<br/>âœ“ Data residency requirements<br/>âœ“ Each region has its own cluster<br/>âœ“ No cross-region traffic desired"]

        rbUC["RegionBound Mode<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Single cluster serves all regions<br/>âœ“ Cross-region failover<br/>âœ“ Cost optimization (fewer clusters)<br/>âœ“ Centralized traffic management"]

        migUC["Orphan Region Adoption<br/>â”€â”€â”€â”€â”€â”€â”€<br/>âœ“ Cluster migration in progress<br/>âœ“ Temporary cluster unavailability<br/>âœ“ Gradual region consolidation<br/>âœ“ Disaster recovery scenario"]
    end

    %% Styling
    classDef modeStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    classDef resourceStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef logicStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef resultStyle fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef useCaseStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px

    class activeMode,regionBoundMode,migrationMode modeStyle
    class activeDNSPolicy,rbDNSPolicy,migrationDNSPolicy,migrationCI resourceStyle
    class activeLogic,rbLogic,migrationLogic,activeControllers,rbControllers,migrationControllers logicStyle
    class activeResult,rbResult,migrationResult,activeTraffic,rbTraffic,migTraffic resultStyle
    class activeUC,rbUC,migUC useCaseStyle
